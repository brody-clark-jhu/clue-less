name: Deploy to Azure VM

on:
  push:
    branches: [ main ]
  workflow_dispatch: 

jobs:
  deploy:
    environment: dev
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VM_IP }}
          username: ${{ secrets.VM_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e
            cd ~/brody/clue-less
            git fetch origin
            git reset --hard origin/main
            git clean -fd

            echo "Updating frontend..."
            cd client
            npm install
            npm run build  # This creates the /dist folder Nginx points to

            echo "Updating backend..."
            cd ../server
            python3 -m venv venv
            source venv/bin/activate
            pip install -r requirements.txt

            echo "Starting server..."
            pm2 restart clue-less-backend || pm2 start "venv/bin/python3 -m uvicorn main:app --host 0.0.0.0 --port 5000" --name clue-less-backend

            # Give nginx access to site files
            chmod -R 755 ~/brody/clue-less/client/dist
